name: Keep Streamlit Demo Alive

on:
  schedule:
    # Runs every 6 hours — keeps Streamlit from sleeping (free tier sleeps after 12h)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual trigger from GitHub Actions tab

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Wake up Streamlit demo
        run: |
          echo "Pinging AML Engine demo..."

          # Install playwright
          pip install playwright --quiet
          playwright install chromium --with-deps --quiet

          # Python script to actually wake the app (HTTP GET alone won't work —
          # Streamlit needs a real browser to establish the WebSocket connection)
          python3 << 'EOF'
          import subprocess
          import sys
          import time

          DEMO_URL = "https://aml-detection-engine-ewxnmkbekcg8scjjes7caa.streamlit.app/"

          try:
              from playwright.sync_api import sync_playwright

              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  page = browser.new_page()

                  print(f"Navigating to {DEMO_URL}")
                  page.goto(DEMO_URL, timeout=60000)

                  # Check if app is sleeping — look for wake-up button
                  try:
                      wake_btn = page.locator("text=Yes, get this app back up")
                      if wake_btn.count() > 0:
                          print("App was sleeping — clicking wake button...")
                          wake_btn.first.click()
                          page.wait_for_timeout(15000)  # Wait 15s for boot
                          print("Wake button clicked.")
                      else:
                          print("App is already awake.")
                  except Exception as e:
                      print(f"Wake button check: {e}")

                  # Wait for app to be interactive
                  page.wait_for_timeout(5000)
                  print(f"Page title: {page.title()}")
                  print("Ping complete.")

                  browser.close()

          except Exception as e:
              print(f"Error during ping: {e}")
              sys.exit(1)
          EOF

      - name: Log result
        run: echo "Keep-alive ping completed at $(date -u)"
